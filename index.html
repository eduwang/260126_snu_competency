<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì›Œí¬ìˆ í™œë™ - ë©”ì¸</title>
  <link rel="stylesheet" href="src/common.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="node_modules/sweetalert2/dist/sweetalert2.min.css">
  <style>
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .user-section {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .user-info {
      color: white;
      font-weight: 500;
    }
    
    .login-btn, .logout-btn {
      padding: 0.625rem 1.25rem;
      background: white;
      color: var(--primary-color);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9375rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .login-btn:hover, .logout-btn:hover {
      background: #f3f4f6;
      transform: translateY(-1px);
    }
    
    .nav-item {
      opacity: 0.5;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    
    .nav-item.visible {
      opacity: 1;
      pointer-events: auto;
    }
    
    .nav-item.admin-only {
      display: none;
    }
    
    .nav-item.admin-only.show {
      display: flex;
    }
    
    .qr-code-container {
      width: 100%;
      height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 1.5rem;
      overflow: hidden;
      border-radius: 8px;
      background: #f9fafb;
    }
    
    .qr-code-image {
      width: 80%;
      height: 80%;
      object-fit: contain;
      transition: transform 0.3s ease;
      cursor: pointer;
    }
    
    .nav-item:hover .qr-code-image {
      transform: scale(1.05);
    }
    
    .qr-popup-image {
      max-width: 90vw;
      max-height: 90vh;
      width: auto;
      height: auto;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="header-content">
        <div class="header-text">
          <h1>SNU ì—­ëŸ‰í‰ê°€ ë©´ì ‘ ì„ ë„êµì‚¬ ì›Œí¬ìˆ</h1>
          <p class="subtitle">SNU ì—­ëŸ‰í‰ê°€ ë©´ì ‘ ì„ ë„êµì‚¬ ì›Œí¬ìˆ</p>
        </div>
        <div class="user-section">
          <span id="userInfo" class="user-info">ğŸ” ë¡œê·¸ì¸ í›„ ì´ìš©í•´ ì£¼ì„¸ìš”.</span>
          <button id="loginBtn" class="login-btn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
              <polyline points="10 17 15 12 10 7"></polyline>
              <line x1="15" y1="12" x2="3" y2="12"></line>
            </svg>
            Google ë¡œê·¸ì¸
          </button>
          <button id="logoutBtn" class="logout-btn" style="display: none;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            ë¡œê·¸ì•„ì›ƒ
          </button>
        </div>
      </div>
    </header>

    <main>
      <nav class="nav-menu">
        <a href="01_mock_eval_01_bottle_crack.html" class="nav-item" id="nav-mock-eval-01">
          <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
          </svg>
          <h2>ëª¨ì˜í‰ê°€ - ìœ ë¦¬ë³‘ ê· ì—´ íŒ¨í„´</h2>
          <p>ìœ ë¦¬ë³‘ ê· ì—´ íŒ¨í„´ ë¬¸í•­</p>
        </a>

        <a href="01_mock_eval_02_college_entrance.html" class="nav-item" id="nav-mock-eval-02">
          <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
          </svg>
          <h2>ëª¨ì˜í‰ê°€ - ëŒ€í•™ì…ì‹œì•Œê³ ë¦¬ì¦˜</h2>
          <p>ëŒ€í•™ì…ì‹œì•Œê³ ë¦¬ì¦˜ ë¬¸í•­</p>
        </a>

        <a href="02_probing_question_01_escape_plan.html" class="nav-item" id="nav-probing-01">
          <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            <line x1="9" y1="10" x2="15" y2="10"></line>
            <line x1="9" y1="14" x2="15" y2="14"></line>
          </svg>
          <h2>íƒì¹¨ ì§ˆë¬¸ ë§Œë“¤ê¸° - ëŒ€í”¼ì‹œë®¬ë ˆì´ì…˜</h2>
          <p>ëŒ€í”¼ì‹œë®¬ë ˆì´ì…˜ ë¬¸í•­ íƒì¹¨ ì§ˆë¬¸ ë§Œë“¤ê¸°</p>
        </a>

        <a href="02_probing_question_02_health_inequality.html" class="nav-item" id="nav-probing-02">
          <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            <line x1="9" y1="10" x2="15" y2="10"></line>
            <line x1="9" y1="14" x2="15" y2="14"></line>
          </svg>
          <h2>íƒì¹¨ ì§ˆë¬¸ ë§Œë“¤ê¸° - ê±´ê°•ë¶ˆí‰ë“± ì—°êµ¬</h2>
          <p>ê±´ê°•ë¶ˆí‰ë“± ì—°êµ¬ ê³„íš ë¬¸í•­ íƒì¹¨ ì§ˆë¬¸ ë§Œë“¤ê¸°</p>
        </a>

        <a href="results.html" class="nav-item" id="nav-results">
          <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="8" y1="6" x2="21" y2="6"></line>
            <line x1="8" y1="12" x2="21" y2="12"></line>
            <line x1="8" y1="18" x2="21" y2="18"></line>
            <line x1="3" y1="6" x2="3.01" y2="6"></line>
            <line x1="3" y1="12" x2="3.01" y2="12"></line>
            <line x1="3" y1="18" x2="3.01" y2="18"></line>
          </svg>
          <h2>ë‹¤ë¥¸ ì‚¬ëŒ ê²°ê³¼ ë³´ê¸°</h2>
          <p>ë‹¤ë¥¸ ì°¸ê°€ìë“¤ì´ ì œì‘í•œ íƒì¹¨ì§ˆë¬¸ê³¼ ê²°ê³¼ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</p>
        </a>

        <div class="nav-item visible" id="nav-qr-code">
          <div class="qr-code-container">
            <img src="link_qr.png" alt="QR ì½”ë“œ" class="qr-code-image" id="qr-code-image">
          </div>
          <h2 class="qr-link-text" style="cursor: pointer;">ì›Œí¬ìˆ ë§Œì¡±ë„ ì¡°ì‚¬</h2>
          <p class="qr-link-text" style="cursor: pointer;">Link</p>
        </div>

        <a href="admin.html" class="nav-item admin-only" id="nav-admin">
          <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
          </svg>
          <h2>ê´€ë¦¬ì í˜ì´ì§€</h2>
          <p>ëª¨ë“  ë°ì´í„°ë¥¼ í™•ì¸í•˜ê³  ì‚¬ìš©ìë¥¼ ë“±ë¡í•©ë‹ˆë‹¤.</p>
        </a>
      </nav>
    </main>

    <footer class="footer">
      <p>&copy; 2026 SNU ì—­ëŸ‰í‰ê°€ ë©´ì ‘ ì„ ë„êµì‚¬ ì›Œí¬ìˆ</p>
    </footer>
  </div>

  <script type="module">
    import { auth, db, googleProvider, isAdmin, addAdmin } from './src/firebaseConfig.js';
    import { signInWithPopup, signOut, onAuthStateChanged } from 'firebase/auth';
    import { doc, getDoc, query, where, getDocs, collection, setDoc, serverTimestamp } from 'firebase/firestore';
    import Swal from 'sweetalert2';

    // DOM ìš”ì†Œ
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const userInfo = document.getElementById('userInfo');
    const navItems = {
      mockEval01: document.getElementById('nav-mock-eval-01'),
      mockEval02: document.getElementById('nav-mock-eval-02'),
      probing01: document.getElementById('nav-probing-01'),
      probing02: document.getElementById('nav-probing-02'),
      results: document.getElementById('nav-results'),
      admin: document.getElementById('nav-admin')
    };
    
    const qrCodeItem = document.getElementById('nav-qr-code');
    
    // QR ì½”ë“œ í•­ëª©ì€ í•­ìƒ í™œì„±í™”
    if (qrCodeItem) {
      qrCodeItem.classList.add('visible');
    }

    // ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    loginBtn.addEventListener('click', async () => {
      console.log('ğŸ” ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ë¨');
      
      // ë¡œë”© ì•Œë¦¼ í‘œì‹œ
      Swal.fire({
        title: 'ë¡œê·¸ì¸ ì¤‘...',
        text: 'Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.',
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      try {
        console.log('ğŸ” Google ë¡œê·¸ì¸ íŒì—… ì—´ê¸° ì‹œë„...');
        const result = await signInWithPopup(auth, googleProvider);
        console.log('âœ… ë¡œê·¸ì¸ ì„±ê³µ:', result.user.email);
        
        // ë¡œë”© ì•Œë¦¼ ë‹«ê¸° (onAuthStateChangedì—ì„œ ì²˜ë¦¬)
        Swal.close();
        
      } catch (error) {
        console.error('âŒ ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
        console.error('ì—ëŸ¬ ì½”ë“œ:', error.code);
        console.error('ì—ëŸ¬ ë©”ì‹œì§€:', error.message);
        
        let errorMessage = 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
        let errorTitle = 'ë¡œê·¸ì¸ ì‹¤íŒ¨';
        
        if (error.code === 'auth/popup-closed-by-user') {
          errorMessage = 'ë¡œê·¸ì¸ ì°½ì´ ë‹«í˜”ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
          errorTitle = 'ë¡œê·¸ì¸ ì·¨ì†Œ';
        } else if (error.code === 'auth/cancelled-popup-request') {
          errorMessage = 'ë¡œê·¸ì¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.';
        } else if (error.code === 'auth/popup-blocked') {
          errorMessage = 'íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ íŒì—…ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
        } else if (error.code === 'auth/unauthorized-domain') {
          errorMessage = 'ì¸ì¦ë˜ì§€ ì•Šì€ ë„ë©”ì¸ì…ë‹ˆë‹¤. Firebase Consoleì—ì„œ ë„ë©”ì¸ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.';
        } else if (error.message) {
          errorMessage = error.message;
        }
        
        Swal.fire({
          icon: 'error',
          title: errorTitle,
          text: errorMessage,
          confirmButtonText: 'í™•ì¸'
        });
      }
    });

    // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    logoutBtn.addEventListener('click', async () => {
      const result = await Swal.fire({
        title: 'ë¡œê·¸ì•„ì›ƒ',
        text: 'ì •ë§ ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'ë¡œê·¸ì•„ì›ƒ',
        cancelButtonText: 'ì·¨ì†Œ',
        confirmButtonColor: '#ef4444'
      });

      if (result.isConfirmed) {
        try {
          await signOut(auth);
          Swal.fire({
            icon: 'success',
            title: 'ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ',
            text: 'ì„±ê³µì ìœ¼ë¡œ ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.',
            timer: 1500,
            showConfirmButton: false
          });
        } catch (error) {
          console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
          Swal.fire({
            icon: 'error',
            title: 'ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨',
            text: 'ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
            confirmButtonText: 'í™•ì¸'
          });
        }
      }
    });

    // ë©”ë‰´ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ë° ì ìš©
    async function loadMenuSettings() {
      try {
        const settingsDoc = await getDoc(doc(db, 'menuSettings', 'main'));
        const settings = settingsDoc.exists() ? settingsDoc.data() : {};
        
        // ê° ë²„íŠ¼ì˜ í‘œì‹œ ì—¬ë¶€ ì„¤ì •
        if (navItems.mockEval01) {
          navItems.mockEval01.style.display = (settings.mockEval01 !== false) ? 'flex' : 'none';
        }
        if (navItems.mockEval02) {
          navItems.mockEval02.style.display = (settings.mockEval02 !== false) ? 'flex' : 'none';
        }
        if (navItems.probing01) {
          navItems.probing01.style.display = (settings.probing01 !== false) ? 'flex' : 'none';
        }
        if (navItems.probing02) {
          navItems.probing02.style.display = (settings.probing02 !== false) ? 'flex' : 'none';
        }
        if (navItems.results) {
          navItems.results.style.display = (settings.activity2 !== false) ? 'flex' : 'none';
        }
        if (qrCodeItem) {
          qrCodeItem.style.display = (settings.qrCode !== false) ? 'flex' : 'none';
        }
      } catch (error) {
        console.error('ë©”ë‰´ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
      }
    }

    // ë„¤ë¹„ê²Œì´ì…˜ í•­ëª© í´ë¦­ ì´ë²¤íŠ¸ (ë¡œê·¸ì¸ ì²´í¬)
    Object.values(navItems).forEach(navItem => {
      if (navItem && navItem !== navItems.admin) {
        navItem.addEventListener('click', (e) => {
          if (!auth.currentUser) {
            e.preventDefault();
            Swal.fire({
              icon: 'warning',
              title: 'ë¡œê·¸ì¸ í•„ìš”',
              text: 'ì´ í˜ì´ì§€ë¥¼ ì´ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.',
              confirmButtonText: 'í™•ì¸'
            });
          }
        });
      }
    });
    
    // QR ì½”ë“œ ì´ë¯¸ì§€ í´ë¦­ ì´ë²¤íŠ¸ - ì´ë¯¸ì§€ í™•ëŒ€ íŒì—…
    const qrCodeImage = document.getElementById('qr-code-image');
    if (qrCodeImage) {
      qrCodeImage.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        Swal.fire({
          html: `<img src="link_qr.png" alt="QR ì½”ë“œ" class="qr-popup-image">`,
          width: 'auto',
          padding: '2rem',
          showConfirmButton: true,
          confirmButtonText: 'ë‹«ê¸°',
          customClass: {
            popup: 'qr-popup',
            htmlContainer: 'qr-popup-container'
          },
          didOpen: () => {
            const popup = document.querySelector('.qr-popup');
            if (popup) {
              popup.style.textAlign = 'center';
            }
          }
        });
      });
    }
    
    // í…ìŠ¤íŠ¸ í´ë¦­ ì´ë²¤íŠ¸ - Google Forms ë§í¬ë¡œ ì´ë™
    const qrLinkTexts = document.querySelectorAll('.qr-link-text');
    qrLinkTexts.forEach(textElement => {
      textElement.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        window.open('https://docs.google.com/forms/d/e/1FAIpQLSdDQxJBWnsGv_pkY3zqeFwGaBCApsTQkNrIl0PFyL3Y-0YPsA/viewform', '_blank');
      });
    });

    // ì‚¬ìš©ì ë“±ë¡ ì²˜ë¦¬ í•¨ìˆ˜
    let isRegistering = false;
    let registrationComplete = false;
    async function handleUserRegistration(user) {
      isRegistering = true;
      registrationComplete = false;
      try {
        // users ì»¬ë ‰ì…˜ì—ì„œ í•´ë‹¹ UIDë¡œ ì´ë¯¸ ë“±ë¡ëœ ì‚¬ìš©ì í™•ì¸
        const userQuery = query(collection(db, 'users'), where('uid', '==', user.uid));
        const userSnapshot = await getDocs(userQuery);
        
        if (!userSnapshot.empty) {
          // ì´ë¯¸ ë“±ë¡ëœ ì‚¬ìš©ì
          const userData = userSnapshot.docs[0].data();
          const displayName = userData.name 
            ? `${userData.name}${userData.affiliation ? ` (${userData.affiliation})` : ''}`
            : (user.displayName || user.email);
          
          userInfo.textContent = `ğŸ‘¤ ${displayName} ë‹˜`;
          isRegistering = false;
          registrationComplete = true;
          // UI ì—…ë°ì´íŠ¸
          await updateUserUI(user);
          return;
        }
        
        // ì²« ë¡œê·¸ì¸ - ì½”ë“œ ì…ë ¥ ë°›ê¸°
        const codeResult = await Swal.fire({
          title: 'ì½”ë“œ ì…ë ¥',
          html: `
            <p style="margin-bottom: 1rem; color: #6b7280;">ì²« ë¡œê·¸ì¸ì…ë‹ˆë‹¤. ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
            <input id="swal-code" class="swal2-input" placeholder="ì½”ë“œ ì…ë ¥" style="text-transform: uppercase;" maxlength="5">
          `,
          showCancelButton: false,
          confirmButtonText: 'í™•ì¸',
          cancelButtonText: 'ì·¨ì†Œ',
          allowOutsideClick: false,
          allowEscapeKey: false,
          preConfirm: () => {
            const code = document.getElementById('swal-code').value.trim().toUpperCase();
            if (!code) {
              Swal.showValidationMessage('ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
              return false;
            }
            return code;
          }
        });
        
        if (!codeResult.isConfirmed) {
          // ì½”ë“œ ì…ë ¥ ì·¨ì†Œ ì‹œ ë¡œê·¸ì•„ì›ƒ
          await signOut(auth);
          isRegistering = false;
          return;
        }
        
        const code = codeResult.value;
        
        // ê´€ë¦¬ì ì½”ë“œ í™•ì¸
        if (code === '12345') {
          // ê´€ë¦¬ìë¡œ ë“±ë¡
          await addAdmin(user.uid);
          await Swal.fire({
            icon: 'success',
            title: 'ê´€ë¦¬ì ë“±ë¡ ì™„ë£Œ',
            text: 'ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.',
            timer: 2000,
            showConfirmButton: false
          });
          userInfo.textContent = `ğŸ‘¤ ${user.displayName || user.email} ë‹˜ (ê´€ë¦¬ì)`;
          isRegistering = false;
          registrationComplete = true;
          // UI ì—…ë°ì´íŠ¸
          await updateUserUI(user);
          return;
        }
        
        // ì¼ë°˜ ì‚¬ìš©ì ì½”ë“œ í™•ì¸
        const codeQuery = query(collection(db, 'users'), where('code', '==', code));
        const codeSnapshot = await getDocs(codeQuery);
        
        if (codeSnapshot.empty) {
          await Swal.fire({
            icon: 'error',
            title: 'ì½”ë“œ ì˜¤ë¥˜',
            text: 'ì˜¬ë°”ë¥¸ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.',
            confirmButtonText: 'í™•ì¸'
          });
          await signOut(auth);
          isRegistering = false;
          registrationComplete = true;
          return;
        }
        
        // ì½”ë“œê°€ ì´ë¯¸ ì‚¬ìš©ëœ ê²½ìš°
        const userDoc = codeSnapshot.docs[0];
        const userData = userDoc.data();
        if (userData.uid) {
          await Swal.fire({
            icon: 'error',
            title: 'ì½”ë“œ ì‚¬ìš© ë¶ˆê°€',
            text: 'ì´ë¯¸ ì‚¬ìš©ëœ ì½”ë“œì…ë‹ˆë‹¤.',
            confirmButtonText: 'í™•ì¸'
          });
          await signOut(auth);
          isRegistering = false;
          registrationComplete = true;
          return;
        }
        
        // ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
        await setDoc(doc(db, 'users', userDoc.id), {
          ...userData,
          uid: user.uid,
          email: user.email,
          linkedAt: serverTimestamp()
        }, { merge: true });
        
        const displayName = userData.name 
          ? `${userData.name}${userData.affiliation ? ` (${userData.affiliation})` : ''}`
          : (user.displayName || user.email);
        
        await Swal.fire({
          icon: 'success',
          title: 'ë“±ë¡ ì™„ë£Œ',
          text: `${displayName}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`,
          timer: 2000,
          showConfirmButton: false
        });
        
        userInfo.textContent = `ğŸ‘¤ ${displayName} ë‹˜`;
        isRegistering = false;
        registrationComplete = true;
        // UI ì—…ë°ì´íŠ¸
        await updateUserUI(user);
        
      } catch (error) {
        console.error('ì‚¬ìš©ì ë“±ë¡ ì˜¤ë¥˜:', error);
        await Swal.fire({
          icon: 'error',
          title: 'ë“±ë¡ ì‹¤íŒ¨',
          text: error.message || 'ì‚¬ìš©ì ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
          confirmButtonText: 'í™•ì¸'
        });
        await signOut(auth);
        isRegistering = false;
        registrationComplete = true;
      }
    }

    // ì¸ì¦ ìƒíƒœ ë³€ê²½ ê°ì§€
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // ë“±ë¡ ì²˜ë¦¬ ì¤‘ì´ë©´ ê¸°ë‹¤ë¦¼ (handleUserRegistrationì´ ì™„ë£Œë  ë•Œê¹Œì§€)
        if (isRegistering) {
          // ë“±ë¡ ì™„ë£Œê¹Œì§€ ëŒ€ê¸°
          const checkRegistration = setInterval(async () => {
            if (registrationComplete) {
              clearInterval(checkRegistration);
              // ë“±ë¡ ì™„ë£Œ í›„ UI ì—…ë°ì´íŠ¸
              await updateUserUI(user);
            }
          }, 100);
          return;
        }
        
        // ì²« ë¡œê·¸ì¸ì¸ì§€ í™•ì¸
        const userQuery = query(collection(db, 'users'), where('uid', '==', user.uid));
        const userSnapshot = await getDocs(userQuery);
        const adminDoc = await getDoc(doc(db, 'adminUsers', user.uid));
        
        // ì´ë¯¸ ë“±ë¡ëœ ì‚¬ìš©ìì´ê±°ë‚˜ ê´€ë¦¬ìì¸ ê²½ìš°
        if (!userSnapshot.empty || adminDoc.exists()) {
          await updateUserUI(user);
        } else {
          // ì²« ë¡œê·¸ì¸ - ì½”ë“œ ì…ë ¥ ì²˜ë¦¬
          // handleUserRegistration ë‚´ì—ì„œ updateUserUIë¥¼ í˜¸ì¶œí•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” í˜¸ì¶œí•˜ì§€ ì•ŠìŒ
          await handleUserRegistration(user);
        }
      } else {
        // ë¡œê·¸ì•„ì›ƒëœ ê²½ìš°
        userInfo.textContent = 'ğŸ” ë¡œê·¸ì¸ í›„ ì´ìš©í•´ ì£¼ì„¸ìš”.';
        loginBtn.style.display = 'flex';
        logoutBtn.style.display = 'none';

        // ëª¨ë“  ë„¤ë¹„ê²Œì´ì…˜ í•­ëª© ë¹„í™œì„±í™” (QR ì½”ë“œ ì œì™¸)
        Object.values(navItems).forEach(navItem => {
          if (navItem) {
            navItem.classList.remove('visible');
          }
        });
        
        // QR ì½”ë“œ í•­ëª©ì€ í•­ìƒ í™œì„±í™” ìœ ì§€
        if (qrCodeItem) {
          qrCodeItem.classList.add('visible');
        }

        // ê´€ë¦¬ì ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        navItems.admin.classList.remove('show');
        
        sessionStorage.removeItem('justLoggedIn');
      }
    });
    
    // ì‚¬ìš©ì UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    async function updateUserUI(user) {
      // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      try {
        const userQuery = query(collection(db, 'users'), where('uid', '==', user.uid));
        const userSnapshot = await getDocs(userQuery);
        
        let displayName = user.displayName || user.email;
        if (!userSnapshot.empty) {
          const userData = userSnapshot.docs[0].data();
          if (userData.name) {
            displayName = `${userData.name}${userData.affiliation ? ` (${userData.affiliation})` : ''}`;
          }
        }
        
        userInfo.textContent = `ğŸ‘¤ ${displayName} ë‹˜`;
      } catch (error) {
        console.error('ì‚¬ìš©ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
        userInfo.textContent = `ğŸ‘¤ ${user.displayName || user.email} ë‹˜`;
      }
      
      loginBtn.style.display = 'none';
      logoutBtn.style.display = 'flex';

      // ëª¨ë“  ë„¤ë¹„ê²Œì´ì…˜ í•­ëª© í™œì„±í™”
      Object.values(navItems).forEach(navItem => {
        if (navItem) {
          navItem.classList.add('visible');
        }
      });

      // ë©”ë‰´ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ë° ì ìš©
      await loadMenuSettings();

      // ê´€ë¦¬ì ì—¬ë¶€ í™•ì¸
      const userIsAdmin = await isAdmin(user.uid);
      if (userIsAdmin) {
        navItems.admin.classList.add('show');
      } else {
        navItems.admin.classList.remove('show');
      }

      // ë¡œê·¸ì¸ ì„±ê³µ ì•Œë¦¼ (ì²˜ìŒ ë¡œê·¸ì¸í•œ ê²½ìš°ì—ë§Œ, ë“±ë¡ ì™„ë£Œëœ ê²½ìš°ëŠ” handleUserRegistrationì—ì„œ ì´ë¯¸ í‘œì‹œ)
      if (sessionStorage.getItem('justLoggedIn') !== 'true' && !isRegistering && !registrationComplete) {
        sessionStorage.setItem('justLoggedIn', 'true');
        // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ ë¡œë”©ì´ ì™„ì „íˆ ë‹«íŒ í›„ í‘œì‹œ
        setTimeout(() => {
          Swal.fire({
            icon: 'success',
            title: 'ë¡œê·¸ì¸ ì„±ê³µ',
            text: `${user.displayName || user.email}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`,
            timer: 2000,
            showConfirmButton: false
          });
        }, 300);
      }
    }
  </script>
</body>
</html>
